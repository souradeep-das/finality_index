import { createPool } from "../pool/createPool.js";
import { createProxy } from "./createProxy.js";
import { Server } from "node:http";
/**
 * Creates and starts a proxy server that spawns anvil instance on demand.
 *
 * @example
 * ```
 * import { startProxy } from "@viem/anvil";
 *
 * // Returns a function to shut down the proxy and all created anvil instances.
 * const shutdown = await startProxy({
 *   port: 8555,
 *   options: {
 *     forkUrl: "https://eth-mainnet.alchemyapi.io/v2/<API_KEY>",
 *     blockNumber: 12345678,
 *   },
 * });
 *
 * // Shut down the proxy and all created anvil instances.
 * await shutdown();
 * ```
 */
export async function startProxy({ port = 8545, host = "::", pool = createPool(), ...rest } = {}) {
    // rome-ignore lint/suspicious/noAsyncPromiseExecutor: this is fine ...
    const server = await new Promise(async (resolve, reject) => {
        const server = await createProxy({ pool, ...rest });
        server.on("listening", () => resolve(server));
        server.on("error", (error) => reject(error));
        server.listen(port, host);
    });
    return async () => {
        const shutdown = new Promise((resolve, reject) => {
            server.close((error) => (error ? reject(error) : resolve()));
        });
        await Promise.allSettled([pool.empty(), shutdown]);
    };
}
//# sourceMappingURL=startProxy.js.map